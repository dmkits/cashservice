<BorderContainer id="exportProds_PageContent" style="width:100%;height:100%;">
    <ContentPane id="exportProds_TopContent" region="top" style="width:100%;margin:0;padding:0;display:inline-block">
        <table width="100%" style="margin:0;background-color:#e7e7e7;font-weight:bold;">
            <tr>
                <td></td>
                <td width="350px" style="text-align:center;font-size:12px;">Выгрузка номенклатур с ценами в Unisystem Cashserver</td>
                <td width="90px"><button id="exportProds_btnExportProds">Export prods</button></td>
                <td width="90px"><button id="exportProds_rtnCleanResult">Clean result</button></td>
                <td></td>
            </tr>
        </table>
    </ContentPane>
    <ContentPane id="exportProds_LeftContent" region="left" style="width:252px;height:100%;margin:0;padding:0;text-align:center">
        <div id="exportProds_header" style="height:26px;font-weight:bold;text-align:center;font-size:11px;padding-top:3px;padding-bottom:0;border-bottom:solid 1px #b7bec9;background-color:#e7e7e7">Кассовые аппараты<br/>(тип ЭККА MINI-T)</div>
        <table align="center" width="100%" style="margin-top: 0px">
            <tr><td id="exportProds_cashboxesButtons"></td></tr>
        </table>
    </ContentPane>
    <LayoutContainer id="exportProds_DetailContent" region="center" style="width:100%;height:100%; margin:0;padding:0; overflow: hidden">
        <ContentPane region="top" style="color:dimgray;font-weight:bold;text-align:center;padding-top:8px;padding-bottom:7px;border-bottom:solid 1px #b7bec9;background-color:#e7e7e7">Результат обработки</ContentPane>
        <ContentPane region="center" id="exportProds_Results" style="border:none;width:100%;height:calc(100% - 45px);overflow-y:scroll"></ContentPane>
    </LayoutContainer>
    <LayoutContainer id="exportProds_RightContent" region="right" splitter="true" style="width:600px;height:100%;margin:0;padding:0;">
        <ContentPane region="top" style="color:dimgray;font-weight:bold;text-align:center;padding-top:8px;padding-bottom:7px;border-bottom:solid 1px #b7bec9;background-color:#e7e7e7">XML</ContentPane>
        <ContentPane region="center" id="exportProds_XML" style="border:none;width:100%;height:calc(100% - 55px);font-size:10px;overflow-y:scroll"></ContentPane>
    </LayoutContainer>
</BorderContainer>
<script type="text/javascript">                                                                             log("exportProds",$$);
    moment.locale("uk");
    var getAllCashBoxes=function() {
        $$.request.getJSONData({url:"/sysadmin/getCashboxes", consoleLog:true},
                function (result,error){
                    setToggleCashBoxID(result.items);
                });
    };
    var cashBoxesList=[];
    var setToggleCashBoxID=function(data){
        for(var i in data){
            var id="exportProds_btnCRID_"+data[i].CRID;
            $$.$.addWigetTo($$.exportProds_cashboxesButtons,"ToggleButton",
                    { id:id, iconClass:'dijitCheckBoxIcon',fStyle:"width:235px;", label:data[i].CRName+" "+data[i].FacID, crid:data[i].CRID });
            cashBoxesList.push($$[id]);
        }
        $$.$.addWigetTo($$.exportProds_cashboxesButtons,"Button",
                {id:"exportProds_btnAllCRs",label:"Все кассы", crid:"export_prods-1",style:"margin-top:10px;",fStyle:"width:235px;",
                    onClick:function(){
                        var count = 0;
                        for(var j in cashBoxesList)
                            if(cashBoxesList[j].get('checked')==true) count++;
                        if(count<cashBoxesList.length){
                            for(var i in cashBoxesList) cashBoxesList[i].set('checked', true);
                            return;
                        }
                        for(var i in cashBoxesList) cashBoxesList[i].set('checked', false);
                    }
                });
        cashBoxesList[0].set('checked', true);
    };
    $$.exportProds_btnExportProds.onClick=function(){
        $$.exportProds_Results.domNode.innerHTML+="<br><b>Начат процесс выгрузки номенклатур с ценами в кассовый шлюз...</b>";
        $$.exportProds_btnExportProds.set('disabled','true');
        var queryParams="";
        for(var i in cashBoxesList){
            if(cashBoxesList[i].checked!==true) continue;
            var cashboxCondition = "cashbox_"+i+"crid="+cashBoxesList[i].crid;
            if(queryParams.length>0) queryParams+="&";
            queryParams+= cashboxCondition;
        }
        $$.request.getJSONData({url:"/sysadmin/exportProds/createXMLandSendToUniCashserver",conditions:queryParams,
                    // timeout:"5000",
                    consoleLog: true},
                function(result,error){
                    $$.exportProds_btnExportProds.set('disabled',false);
                    $$.exportProds_XML.domNode.innerText="";
                    if(result&&result.xmlText){
                        $$.exportProds_Results.domNode.innerHTML+='<br>Сгенерирован документ XML';
                        $$.exportProds_XML.domNode.innerText=result.xmlText;
                    }
                    if(result&&result.nullLineCounter)
                        $$.exportProds_Results.domNode.innerHTML+='<br>Найдены товары без наименования. Всего: '+result.nullLineCounter+' товара';
                    if(error){
                        $$.exportProds_Results.domNode.innerHTML+='<br><b><span style="color:red">Невозможно выполнить операцию! '+error.message+'</span></b><br>';
                        return;
                    }
                    $$.exportProds_Results.domNode.innerHTML+='<br><b>ВЫГРУЗКА ЗАВЕРШЕНА.</b>';
                    if(result.serverResp)
                        $$.exportProds_Results.domNode.innerHTML+='<br><b>ОТВЕТ КАССОВОГО ШЛЮЗА: '+result.serverResp+'</b>';
                    $$.exportProds_Results.domNode.innerHTML+='<br>';
                });
    };
    $$.exportProds_rtnCleanResult.onClick = function () {
        var displayResult = $$.exportProds_Results.domNode;
        while(displayResult.firstChild) displayResult.removeChild(displayResult.firstChild);
    };
    getAllCashBoxes();
</script>