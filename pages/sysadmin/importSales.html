<BorderContainer id="importSales_PageContent" style="width:100%;height:100%;">
    <ContentPane id="importSales_TopContent" region="top" style="width:100%; margin:0;padding:0;display:inline-block">
        <table width="100%" style="margin:0;background-color:#e7e7e7;font-weight:bold;">
            <tr>
                <td></td>
                <td width="350px" style="text-align:center;font-size:12px;">Загрузка кассовых операций из Unisystem Cashserver</td>
                <td width="200px" style="text-align:right"><DateTextBox type="date" id="importSales_BDate" label="Начальна дата:" style="width:85px"></DateTextBox></td>
                <td width="10px"></td>
                <td width="200px"><DateTextBox type="date" id="importSales_EDate" label="Конечная дата:"style="width:85px"></DateTextBox></td>
                <td width="10px"></td>
                <td width="90px"><button id="importSales_btnStartImport">Import sales from UNI cashserver</button></td>
                <td width="90px"><button id="importSales_btnClean">Clean up</button></td>
                <td width="20px"></td>
                <td width="70px"><button id="importSales_btnGetXMLFromUniCashserver">get XML from Uni cashserver</button></td>
                <td width="70px"><button id="importSales_btnLoadXML">Load last XML</button></td>
                <td width="90px"><button id="importSales_btnImportFromXMLToDB">Import XML to DB</button></td>
                <td></td>
            </tr>
        </table>
    </ContentPane>
    <ContentPane id="importSales_LeftContent" region="left" style="width:252px;height:100%; margin:0;padding:0;">
        <div style="height:26px;font-weight:bold;text-align:center;font-size:11px;padding-top:3px;padding-bottom:0;border-bottom:solid 1px #b7bec9;background-color:#e7e7e7">Кассовые аппараты<br/>(тип ЭККА MINI-T)</div>
        <table align="center" width="100%" style="margin: 0px">
            <tr><td id="importSales_cashBoxesButtons"></td></tr>
        </table>
    </ContentPane>
    <ContentPane id="importSales_DetailContent" region="center" style="width:100%;height:100%; margin:0;padding:0;overflow:hidden">
        <ContentPane region="top" style="color:dimgray;font-weight:bold;text-align:center;padding-top:8px;padding-bottom:7px;border-bottom:solid 1px #b7bec9;background-color:#e7e7e7">Результат обработки</ContentPane>
        <ContentPane id="importSales_Results" style="border:none;/*width:100%*/;height:calc(100% - 45px);overflow-y:scroll"></ContentPane>
    </ContentPane>
    <LayoutContainer id="importSales_RightContent" region="right" splitter="true" style="width:600px;height:100%; margin:0;padding:0;">
        <ContentPane region="top" style="color:dimgray;font-weight:bold;text-align:center;padding-top:8px;padding-bottom:7px;border-bottom:solid 1px #b7bec9;background-color:#e7e7e7">XML</ContentPane>
        <ContentPane region="center" id="importSales_XML" style="border:none;width:100%;height:calc(100% - 55px);font-size:10px;overflow-y:scroll"></ContentPane>
    </LayoutContainer>
</BorderContainer>
<script type="text/javascript">                                                                             log("importSales",$$);
    moment.locale("uk");
    $$.importSales_BDate.set("value",$$.yesterday());
    $$.importSales_EDate.set("value",$$.yesterday());
    var getAllCashBoxes=function(){
        $$.request.getJSONData({url: "/sysadmin/getCashboxes", consoleLog: true},
                function (result,error){
                    if(result)setToggleCashBoxID(result.items);
                });
    };
    var cashBoxesList=[];
    var setToggleCashBoxID=function(data){
        for(var i in data){
            var id="importSales_btnCRID_"+data[i].CRID;
            $$.$.addWigetTo($$.importSales_cashBoxesButtons,"ToggleButton",
                    { id:id, iconClass:'dijitCheckBoxIcon',fStyle:"width:235px;", label:data[i].CRName+" "+data[i].FacID, crid:data[i].CRID });
            cashBoxesList.push($$[id]);
        }
        cashBoxesList[0].set('checked',true);
        $$.$.addWigetTo($$.importSales_cashBoxesButtons,"Button",
                {id:"importSales_btnAllCRs",label:"Все кассы", crid:"import_sales-1",style:"margin-top:10px;",fStyle:"width:235px;",
                    onClick:function(){
                        var count = 0;
                        for(var j in cashBoxesList)
                            if(cashBoxesList[j].get('checked') == true)count++;
                        if(count<cashBoxesList.length){
                            for(var i in cashBoxesList)cashBoxesList[i].set('checked', true);
                            return;
                        }
                        for(var i in cashBoxesList)cashBoxesList[i].set('checked', false);
                    }
                });
    };
    disableBtns= function(disable){
        if(disable===undefined)disable=true;
        $$.importSales_btnStartImport.set('disabled',disable);
        $$.importSales_btnClean.set('disabled',disable);
        $$.importSales_btnGetXMLFromUniCashserver.set('disabled',disable);
        $$.importSales_btnLoadXML.set('disabled',disable);
        $$.importSales_btnImportFromXMLToDB.set('disabled',disable);
    };
    getQueryConditionsForXML= function(){
        var bdateValue=$$.importSales_BDate.get("value"), bdate= moment(bdateValue).format('YYYYMMDD')+"0000",
                edateValue=$$.importSales_EDate.get("value"), edate= moment(edateValue).format('YYYYMMDD')+"2359",
                queryParams="";
        for(var i in cashBoxesList){
            if(cashBoxesList[i].checked!==true) continue;
            var cashbox_condition = "cashbox_" + i + "crid=" + cashBoxesList[i].crid;
            if(queryParams.length>0) queryParams+="&";
            queryParams+= cashbox_condition;
        }
        return "bdate="+bdate+"&edate="+edate+"&"+queryParams;
    };
    $$.importSales_btnStartImport.onClick=function(){
        disableBtns();
        var resultNode=$$.importSales_Results.domNode;
        resultNode.innerHTML+='<br><b>Начат импорт кассовых операций из UNI Cashserver...</b>';
        $$.importSales_XML.domNode.innerText="";
        $$.request.getJSONData({url:"/sysadmin/importSales/getSalesXMLFromUniCashserverAndStoreToDB",
                    conditions:getQueryConditionsForXML(), timeout:"5000",consoleLog: true},
                function (result,error){                                                                    log("importSales_btnStartImport.onClick Request.getJSONData result=",result);
                    disableBtns(false);
                    if(error){
                        resultNode.innerHTML+='<br><b><span style="color:red">Не удалось импортировать кассовые операции из UNI Cashserver! '+error.message+'</b><br>';
                        return;
                    }
                    if(result) $$.importSales_XML.domNode.innerText=result.uniXML;
                    resultNode.innerHTML+='<br><b>Кассовые операции из UNI Cashserver успешно импортированы.</b><br>';
                });
    };
    var socket = io.connect(/*'http://localhost:8080'*/);
    socket.on('new_event', function(data){
        $$.importSales_Results.domNode.innerHTML+='<br>'+data;
    });

    $$.importSales_btnClean.onClick = function(){
        var resultNode=$$.importSales_Results.domNode;
        while (resultNode.firstChild) resultNode.removeChild(resultNode.firstChild);
        $$.importSales_XML.domNode.innerText="";
    };
    $$.importSales_btnGetXMLFromUniCashserver.onClick= function(){
        disableBtns();
        var resultNode=$$.importSales_Results.domNode;
        resultNode.innerHTML+='<br><b>Получение данных кассовых операций в XML из Unisystem cashserver...</b>';
        $$.request.getJSONData({url:"/sysadmin/importSales/getXMLFromUniCashserver",
                    conditions:getQueryConditionsForXML(), timeout:"5000",consoleLog:true},
                function(result,error){                                                                     log("importSales_btnGetXMLFromUniCashserver.onClick Request.getJSONData result=",result,error);
                    disableBtns(false);
                    var resultNode=$$.importSales_Results.domNode;
                    if(error){
                        resultNode.innerHTML+='<br><b><span style="color:red">Не удалось получить данные в XML! '+error.message+'</b><br>';
                        return;
                    }
                    if(result) $$.importSales_XML.domNode.innerText=result.uniXML;
                    resultNode.innerHTML+='<br><b>Данные в XML получены.</b><br>';
                })
    };
    $$.importSales_btnLoadXML.onClick = function(){
        disableBtns();
        $$.request.getJSONData({url:"/sysadmin/importSales/loadXML", timeout:"5000",consoleLog:true},
                function(result,error){                                                                     log("importSales_btnStartImport.onClick Request.getJSONData result=",result,error);
                    disableBtns(false);
                    var resultNode=$$.importSales_Results.domNode;
                    if(error){
                        resultNode.innerHTML+='<br><b><span style="color:red">Не удалось загрузить файл XML! '+error.message+'</b><br>';
                        return;
                    }
                    if(result) $$.importSales_XML.domNode.innerText=result.uniXML;
                    resultNode.innerHTML+='<br><b>Файл XML загружен.</b><br>';
                })
    };
    $$.importSales_btnImportFromXMLToDB.onClick = function(){
        disableBtns();
        var uniXML=$$.importSales_XML.domNode.innerText;
        var resultNode=$$.importSales_Results.domNode;
        resultNode.innerHTML+='<br><b>Начат импорт кассовых операций из XML...</b>';
        $$.request.postJSONData({url:"/sysadmin/importSales/importXMLToDB",data:{uniXML:uniXML}, timeout:"5000",consoleLog: true},
                function (result,error){                                                                    log("importSales_btnStartImport.onClick Request.getJSONData result=",result);
                    disableBtns(false);
                    if(error){
                        resultNode.innerHTML+='<br><b><span style="color:red">Не удалось импортировать кассовые операции из XML! '+error.message+'</b><br>';
                        return;
                    }
                    resultNode.innerHTML+='<br><b>Кассовые операции из XML успешно импортированы.</b><br>';
                });
    };
    getAllCashBoxes();
</script>